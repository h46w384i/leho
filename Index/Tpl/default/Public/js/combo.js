pmc_in_script_time_2880=new Date()*1;BB.provide("textAreaUtils",{});ObjectH.mix(textAreaUtils,function(){var A=document.selection;return{selectionStart:function(E){if(!A){try{return E.selectionStart;}catch(F){return 0;}}var C=A.createRange(),D=0;var B=document.body.createTextRange();B.moveToElementText(E);for(D;B.compareEndPoints("StartToStart",C)<0;D++){B.moveStart("character",1);}return D;},getSelectedText:function(B){var D="";var C=function(E){if(E.selectionStart!==undefined&&E.selectionEnd!=undefined){return E.value.substring(E.selectionStart,E.selectionEnd);}};if(window.getSelection){D=C(B);}else{D=A.createRange().text;}return D;},selectText:function(B,E,D){B.focus();if(!A){B.setSelectionRange(E,D);return ;}var C=A.createTextRange();C.collapse(1);C.moveStart("character",E);C.moveEnd("character",D-E);C.select();},insertText:function(E,G,B,F){E.focus();F=F||0;if(!A){var I=E.value,C=B-F,H=C+G.length;E.value=I.slice(0,C)+G+I.slice(B,I.length);this.selectText(E,H,H);return ;}var D=A.createRange();D.moveStart("character",-F);D.text=G;},replaceText:function(F,G){F.focus();var I=F.value;var E=this.getSelectedText(F);var C=E.length;if(C==0){this.insertText(F,G,this.getCursorPos(F));}else{var B=this.getCursorPos(F);if(A){var D=A.createRange();D.text=G;this.setCursor(F,B+G.length);}else{var H=B+C;F.value=I.slice(0,B)+G+I.slice(B+C,I.length);this.setCursor(F,B+G.length);return ;}}},setCursor:function(C,F,B){F=F==null?C.value.length:F;B=B==null?0:B;try{C.focus();}catch(E){}if(C.createTextRange){var D=C.createTextRange();D.move("character",F);D.moveEnd("character",B);D.select();}else{C.setSelectionRange(F,F+B);}},setCursorToEnd:function(C){C=$(C);var B=C.value.length|0;C.focus();if(C.createTextRange){var D=C.createTextRange();D.moveStart("character",B);D.collapse();D.select();}else{C.setSelectionRange(B,B);}},setCurosrToBefore:function(B){B=$(B);B.focus();if(B.createTextRange){var C=B.createTextRange();C.moveStart("character",0);C.collapse();C.select();}else{B.setSelectionRange(0,0);}},getCursorPos:function(B){var D=0;if(BB.Env.ie){try{B.focus();}catch(E){}var C=null;C=A.createRange();var E=C.duplicate();E.moveToElementText(B);E.setEndPoint("EndToEnd",C);B.selectionStart=E.text.length-C.text.length;B.selectionEnd=B.selectionStart+C.text.length;D=B.selectionStart;}else{if(B.selectionStart||B.selectionStart=="0"){D=B.selectionStart;}}return D;},unCoverInsertText:function(E,B,C){C=(C==null)?{}:C;C.rcs=C.rcs==null?E.value.length:C.rcs*1;C.rccl=C.rccl==null?0:C.rccl*1;var D=E.value,G=D.slice(0,C.rcs),F=D.slice(C.rcs+C.rccl,D==""?0:D.length);E.value=G+B+F;this.setCursor(E,C.rcs+(B==null?0:B.length));}};}(),true);pmc_exec_time_2880=new Date()*1-pmc_in_script_time_2880;pmc_in_script_time_6519=new Date()*1;var textAreaUtilsFacade=function(){function B(D){var E=D.getAttribute("range")||"0&0";return E.split("&");}function A(F,E){var D=B(F);var H=D[0];var G=D[1];textAreaUtils.unCoverInsertText(F,E,{rcs:H,rccl:G});C(F);}function C(F){var E=textAreaUtils.getSelectedText(F);var D=(E==""||E==null)?0:E.length;var H=textAreaUtils.getCursorPos(F);var G=H+"&"+D;F.setAttribute("range",G);}return{insertText:A,cacheCurPos:C};}();pmc_exec_time_6519=new Date()*1-pmc_in_script_time_6519;pmc_in_script_time_8917=new Date()*1;(function(){var H=BB.ObjectH,G=BB.CustEvent,D=BB.EventTargetH,I=BB.EventH,C=BB.DomU,B=BB.NodeH,A=BB.StringH;var F=function(){this.core=null;this._timer=null;this.limitCount=140;this.setFocus=true;this.widgets=[];this.checkGuard=function(E,J){if(J>0&&E){return true;}else{return false;}};this.guard=false;this.initialize.apply(this,arguments);};F.EVENTS={overcount:"overcount",unovercount:"unovercount",canpublish:"canpublish",cancelpublish:"cancelpublish"};H.mix(F.prototype,function(){return{initialize:function(L,K){var E=[];this.core=B.$(L);for(var J in F.EVENTS){E.push(J);}G.createEvents(this,E);H.mix(this,K||{},true);},addWidgets:function(E){this.widgets.push(E);},_dispatch:function(K,J){var E=new G(this,K);H.mix(E,J||{});return this.fire(E);},dispatchOverCount:function(E){return this._dispatch(F.EVENTS.overcount,{count:E});},dispatchUnOverCount:function(E){return this._dispatch(F.EVENTS.unovercount,{count:E});},render:function(){var K=this.widgets;for(var J=0,E=K.length;J<E;J++){K[J].render&&K[J].render(this.core);}this._addTriggerHandler();},getGuard:function(){return this.guard;},setGuard:function(E){this.guard=E;},checkText:function(){var K=Math.ceil(A.byteLen(this.core.value)/2);var J=parseInt(this.limitCount,10)-K;var E=J>=0?true:false;if(E){this.dispatchUnOverCount(J);}else{this.dispatchOverCount(Math.abs(J));}this.setGuard(this.checkGuard(E,K));if(this.getGuard()){this._dispatch(F.EVENTS.canpublish);}else{this._dispatch(F.EVENTS.cancelpublish);}},_addTriggerHandler:function(){var E=this;D.on(this.core,"focus",function(){E._timer=setInterval(function(){E.checkText();},20);});D.on(this.core,"blur",function(){clearInterval(E._timer);});D.on(this.core,"keyup",function(){textAreaUtilsFacade.cacheCurPos(this);});D.on(this.core,"mouseup",function(){textAreaUtilsFacade.cacheCurPos(this);});}};}(),true);BB.provide("PublishEditor",F);})();pmc_exec_time_8917=new Date()*1-pmc_in_script_time_8917;pmc_in_script_time_4883=new Date()*1;(function(){var H=BB.ObjectH,G=BB.CustEvent,F=BB.EventTargetH,I=BB.EventH,D=BB.DomU,C=BB.NodeH,B=BB.StringH;var A=function(){this.host=null;this.blankTopic=null;this.hotTopic=null;this.dataTextName="data-text";this.className={blankTopic:"blank-topic",hotTopic:"hot-topic"};this._handlers={insertBlankTopic:null,insertHotTopic:null};this.initialize.apply(this,arguments);};A.CONF={BLANK_TOPIC_TEXT:"#在这里输入你想要说的话题#",TAG:"#"};H.mix(A.prototype,function(){return{initialize:function(J){var E=this;H.mix(this,J||{},true);this._handlers.insertBlankTopic=function(){var K=this.getAttribute(E.dataTextName);E.insertBlankTopic(K);};this._handlers.insertHotTopic=function(){var K=this.getAttribute(E.dataTextName);E.insertHotTopic(K);};this.blankTopic=this.blankTopic||D.query("."+this.className.blankTopic);this.hotTopic=this.hotTopic||D.query("."+this.className.hotTopic);},_addTriggerHandler:function(){var E=this;this.blankTopic.forEach(function(J){F.on(J,"click",E._handlers.insertBlankTopic);});F.delegate(C.$("tag_content"),"a.hot","click",E._handlers.insertHotTopic);},insertBlankTopic:function(L){var K=textAreaUtils.getSelectedText(this.host);var J=A.CONF;var E=K.length*1;if(E==0||J.BLANK_TOPIC_TEXT.indexOf(K)>-1){this.insertHotTopic(L);}else{L=J.TAG+K+J.TAG;textAreaUtils.replaceText(this.host,L);}},insertHotTopic:function(L){var J=this.host.value,E=L.length-A.CONF.TAG.length*2;if(J.indexOf(L)!==-1){var K=J.indexOf(L);textAreaUtils.setCursor(this.host,K+1,E);}else{textAreaUtilsFacade.insertText(this.host,L);var M=textAreaUtils.getCursorPos(this.host);textAreaUtils.setCursor(this.host,M-(E+1),E);}},render:function(E){this.host=E;this._addTriggerHandler();}};}(),true);BB.provide("PublishTopic",A);})();pmc_exec_time_4883=new Date()*1-pmc_in_script_time_4883;pmc_in_script_time_4034=new Date()*1;(function(){var H=BB.ObjectH,G=BB.CustEvent,F=BB.EventTargetH,I=BB.EventH,D=BB.DomU,C=BB.NodeH,A=BB.StringH;var B=function(){this.host=null;this._timer=null;this._showatTime=null;this._hasCreateWrapper=false;this._wrapper=null;this._before=null;this._tag=null;this._after=null;this._finalCss="";this._sug=null;this._sugUrl="http://i.leho.com/suggest/sugat/s?cmd=suggest&type=follow&dataset=usr&max_count=5&charset=utf-8&uid="+__CONF__.login_uid+"&keyword={$query}";this._sugTmpl=['<div class="container"><div class="layer-list cls" style="z-index:100'+(BB.Env.ie6?";height:120px":"")+'">','<ul class="cls">{for (var i=0;i<$data.length;i++)}<li class="listview-item"><a href="javascript:;">','<img alt="头像" title="{$data[i].val}" src="'+__CONF__.img_url+'/img_new/{$data[i].head_imid != "0" ? $data[i].head_imid : __CONF__.man_head_img}--20-20-1">{$data[i].key}</a></li>{/for}</ul></div></div>'].join("");this._storePos=0;this.fontFamily="font-family:Tahoma,宋体";this.initialize.apply(this,arguments);};B.CONF={TAG:"@"};B.EVENTS={matchFriends:"matchFriends",unMatchFriends:"unMatchFriends"};H.mix(B.prototype,function(){return{initialize:function(M){var J=[];for(var L in B.EVENTS){J.push(L);}G.createEvents(this,J);var K=D.create(['<div><div node-type="wrap">','<span node-type="before"></span>','<span node-type="flag"></span>','<span node-type="after"></span>',"</div></div>"].join(""));var E=this._wrapper=K.childNodes[0];this._before=E.childNodes[0];this._tag=E.childNodes[1];this._after=E.childNodes[2];H.mix(this,M||{},true);},_dispatch:function(K,J){var E=new G(this,K);H.mix(E,J||{});return this.fire(E);},matchAtRegular:function(){var M=this.host.value.replace(/\r/g,"");var J=textAreaUtils.selectionStart(this.host);if(J<0||J==this._storePos){return ;}this._storePos=J;var K=M.slice(0,J);var E=K.match(new RegExp(["(",B.CONF.TAG,")([a-zA-Z0-9\u4e00-\u9fa5_]{0,20})$"].join("")));if(!E){this._dispatch(B.EVENTS.unMatchFriends);return ;}var L=M.slice(J);K=K.slice(0,-E[0].length);this.setWrapperContent(K,E[1],E[2],L);},transContent:(function(){var E={"<":"&lt;",">":"&gt;",'"':"&quot;","\\":"&#92;","&":"&amp;","'":"&#039;","\r":"","\n":"<br>"," ":(navigator.userAgent.match(/.+(?:ie) ([\d.]+)/i)||[8])[1]<8?['<pre style="overflow:hidden;display:inline;'+this.fontFamily+';word-wrap:break-word;"> </pre>'].join(""):['<span style="white-space:pre-wrap;font-family:Tahoma,宋体;"> </span>'].join("")};return function(J){var K=J.replace(/(<|>|\"|\\|&|\'|\n|\r| )/g,function(L){return E[L];});return K;};})(),setWrapperContent:function(L,J,K,N){var E=this;var M=this.transContent;this._wrapper.style.cssText=[this._finalCss,"width:",parseInt(C.getCurrentStyle(this.host,"width"),10)||this.host.offsetWidth,"px; height:",parseInt(C.getCurrentStyle(this.host,"height"),10)||this.host.offsetHeight,"px; overflow-x: hidden; overflow-y:",/webkit/i.test(navigator.userAgent)?"hidden":C.getCurrentStyle(this.host,"overflowY",";")].join("");this._before.innerHTML=M(L);this._tag.innerHTML=M(J)||"&thinsp;";this._after.innerHTML=M([K,N].join(""));clearTimeout(this._showatTimer);this._showatTime=setTimeout(function(){var O=C.getRect(E._tag);E._dispatch(B.EVENTS.matchFriends,{top:O.top-E.host.scrollTop+parseInt(W(E.host).getCurrentStyle("padding-top"),10),left:O.left+parseInt(W(E.host).getCurrentStyle("padding-left"),10),key:K,tag:J,host:E.host});},32);},_addTriggerHandler:function(){var E=this;F.on(this.host,"focus",function(){clearInterval(E._timer);E.createWrapper();E._timer=setInterval(function(){E.matchAtRegular();},200);});F.on(this.host,"blur",function(){clearInterval(E._timer);});this._bindSuggest();},buildCss:function(){var J=[],K=this.host.style.cssText,E=this;["margin","padding","border"].forEach(function(L){["top","left","bottom","right"].forEach(function(M){if(L!="border"){J.push(L,"-",M.toLowerCase(),":",NodeH.getCurrentStyle(E.host,L+M),";");return ;}["color","style","width"].forEach(function(N){J.push(L,"-",M.toLowerCase(),"-",N.toLowerCase(),":",NodeH.getCurrentStyle(E.host,[L,M,N].join("")),";");});});});J.push("font-size:"+NodeH.getCurrentStyle(this.host,"fontSize")+";");return[K,J.join(""),this.fontFamily,";word-wrap: break-word; line-height: 18px; overflow-y: auto; overflow-x: hidden; outline: none;"].join("");},createWrapper:function(){var L=C.getRect(this.host);var E=["left:",L.left,"px; top:",L.top+20,"px;"].join("");var J=this.buildCss();this.host.style.cssText=J;var K=this._finalCss=[E,J,"position:absolute; filter:alpha(opacity=0); opacity: 0; z-index: -1000"].join("");this._wrapper.style.cssText=K;if(!this._hasCreateWrapper){this._hasCreateWrapper=true;document.body.appendChild(this._wrapper);}},render:function(E){this.host=E;this.host.AtFriends=this;this._addTriggerHandler();},_bindSuggest:function(){var E=this._sug=new BB.SuggestAt({url:this._sugUrl,template:this._sugTmpl,target:this.host});E.setValue=function(M,K){M=M+" ";var N=E.get("combo").get("target")[0];var J=K.length*1;var L=textAreaUtils.selectionStart(N);textAreaUtils.insertText(N,M,L,J);};}};}(),true);BB.provide("AtFriends",B);})();pmc_exec_time_4034=new Date()*1-pmc_in_script_time_4034;pmc_in_script_time_6120=new Date()*1;(function(){var G=BB.ObjectH,F=BB.CustEvent,D=BB.EventTargetH,I=BB.EventH,C=BB.DomU,B=BB.NodeH,A=BB.StringH;var H=function(){this.host=null;this.className="face";this.containerClassName="editor";this._handlers={popFacePanel:null,selectFace:null};this.initialize.apply(this,arguments);};H.EVENTS={};H.popup=null;H.container=null;G.mix(H.prototype,function(){return{initialize:function(L){var E=this,J=[];for(var K in H.EVENTS){J.push(K);}F.createEvents(this,J);G.mix(this,L||{},true);this._handlers.popFacePanel=function(){H.container=W(this).parentNode("."+E.containerClassName).query("textarea")[0];E.popFacePanel(this);};this._handlers.selectFace=function(){E.selectFace(this);};},render:function(E){if(E==null){return ;}this.host=E;this._addTriggerHandler();},_addTriggerHandler:function(){var E=this;var J=W(this.host).parentNode("."+this.containerClassName).query("."+this.className).first();D.on(J,"click",E._handlers.popFacePanel);},popFacePanel:function(J){var E=this;if(!H.popup){H.popup=new LayerPopup({className:"panel panel-t3 panel-t3-tl panel-faces",header:false,width:330,shadow:true,cue:true,corner:true,close:true});E.buildContent();}H.popup.show(0,30,null,null,J);},buildContent:function(){var E=this;var K=['<div class="faces-cont">','<ul class="faces-list cls">'],J=this;Ajax.get("/publish/getFaceInfo",{_of:"json",tmp:new Date().getTime()},function(L){var M=Ajax.opResults(L,false);if("mcphp.ok"==M.err){var O=M.data.face_info;for(var N in O){K.push('<li data-title="[{0}]"><img src="{1}" alt="{0}" title="{0}"></li>'.format(N,"http://st.youa.com/static/face/"+O[N]+".gif"));}}else{K.push("<li>加载失败...</li>");}K.push("</ul></div>");H.popup.setContent(K.join(""));});W(".panel-faces").delegate("li","click",this._handlers.selectFace);},selectFace:function(E){var J=E.getAttribute("data-title");textAreaUtilsFacade.insertText(H.container,J);H.popup.hide();}};}(),true);BB.provide("PublishFace",H);})();pmc_exec_time_6120=new Date()*1-pmc_in_script_time_6120;
